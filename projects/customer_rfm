WITH rfm_base AS (
  SELECT
    customer_id,
    DATE_DIFF(DATE('2018-09-03'), DATE(MAX(order_purchase_timestamp)), DAY) AS recency,
    COUNT(DISTINCT order_id) AS frequency,
    ROUND(SUM(payment_value), 2) AS monetary
  FROM
    `project-re-learning.Data1.combined_data`
  WHERE
    order_status = 'delivered'
  GROUP BY
    customer_id
),

rfm_score AS (
  SELECT
    customer_id,
    recency,
    frequency,
    monetary,

    NTILE(5) OVER (ORDER BY recency ASC) AS r_score,
    NTILE(5) OVER (ORDER BY frequency DESC) AS f_score,
    NTILE(5) OVER (ORDER BY monetary DESC) AS m_score

  FROM rfm_base
)

SELECT *,
       CONCAT(r_score, f_score, m_score) AS rfm_segment
FROM rfm_score
ORDER BY rfm_segment DESC
